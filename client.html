<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Local LLM Service Test</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<style>
	   body {
        background-color: #f5f5f5;
        font-family: "Helvetica Neue", sans-serif;
      }
      #container {
        display: flex;
        flex-direction: column;
        align-items: left;
        margin-top: 20px;
		margin-right: 10px;
      }
      label {
        text-align: left;
        font-size: 20px;
        margin-bottom: 10px;
        color: #333;
      }
      
	  textarea {
        display: block;
        width: calc(100% - 10px);
        padding: 10px;
        border-radius: 5px;
        border: none;
        background-color: #DDDDDD;
        font-size: 18px;
        color: #333;
        box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);	
		margin-right: 10px;				
		line-height: 1.5;
		padding-top: 10px;			
      }
	  	  	  	  	 
      textarea::placeholder {
        color: #aaa;
        font-style: italic;
      }
	  
      textarea:focus {
        outline: none;
        box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2);
      }
	  
      #question {        		
		height: 150px;
        margin-bottom: 20px;			
      }
	  
      #answer {
        height: 150px;
        margin-bottom: 30px;				
      }
	  
    .btn-group button {
        display: inline-block;
		width: 150px;
		padding: 10px 20px;
		border-radius: 5px;
		border: none;
		background-color: #6495ED;
		color: #fff;
		font-size: 18px;
		cursor: pointer;
		transition: background-color 0.3s ease;
		margin-left: auto;
		margin-right: 10px;
		float: right; /* Float the buttons side by side */
    }
      	 
	.btn-group button:not(:last-child) {
		border-right: none; /* Prevent double borders */
	}
	  	
	.spinner {
    border: 8px solid #f3f3f3;
    border-top: 8px solid #3498db;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
    position: absolute;
    top: 15px;
    right: 25px;
    z-index: 1;
	}

	@keyframes spin {
		0% { transform: rotate(0deg); }
		100% { transform: rotate(360deg); }
	}
	
	#submit-btn:disabled, #submit-btn-async:disabled, #embed-btn:disabled {
	opacity: 0.5;
	cursor: not-allowed;
		
}

    </style>
  </head>
  <body>
     <div id="container">
      <h1>Test Client for Local LLM Service</h1>
      <label for="question">Enter your question:</label>
      <textarea id="question" name="question" placeholder="Enter your question here..."></textarea>
	  <div class="btn-group">		
		<button id="submit-btn" onclick="sendQuestion()" disabled>Query(Sync)</button>
	  	<button id="submit-btn-async" onclick="sendQuestionAsync()" disabled>Query(Async)</button>
		<button id="embed-btn" onclick="sendEmbedRequest()" disabled>Embed Text</button>
	  </div>
	  <div class="spinner" style="display:none;"></div>
	  <label for="answer">Answer:</label>
      <textarea id="answer" rows="5" placeholder="Answer will appear here..."readonly></textarea>
	  <label for="rawresponse">JSON payload:</label>
      <textarea id="rawresponse" rows="10" placeholder="JSON response will appear here..."readonly></textarea>
    </div>
    <script>
      function sendQuestion() {
        closeConnection();	//make sure any streaming event connection currently running is closed
		var question = $("#question").val();
        var data = { "text": question };
		$("#submit-btn").prop("disabled", true); // Disable the submit buttons
		$("#submit-btn-async").prop("disabled", true);
		$("#embed-btn").prop("disabled", true);
		$(".spinner").show(); // Show the loading spinner
		$("#answer").val(""); // clear answer text area
		$("#rawresponse").val(""); //clear raw response text area
        $.ajax({
          type: "POST",
          url: "http://localhost:8000/query",
          data: JSON.stringify(data),
          contentType: "application/json; charset=utf-8",
          dataType: "json",
          success: function(response) {
            $("#answer").val(response.answer);
			$("#rawresponse").val(JSON.stringify(response));
			$("#submit-btn").prop("disabled", false); // Enable the submit buttons
			$("#submit-btn-async").prop("disabled", false);
            $("#embed-btn").prop("disabled", false);
			$(".spinner").hide(); // Hide the loading spinner
          },
          error: function(xhr, status, error) {
            alert("Error: " + error);
			$("#submit-btn").prop("disabled", false); // Enable the submit buttons
			$("#submit-btn-async").prop("disabled", false);
            $("#embed-btn").prop("disabled", false);
			$(".spinner").hide(); // Hide the loading spinner
          }
        });
      }
	
	// setup event handlers to receive answer stream from server
	let eventSource;
	let connectionInProgress = false;
	
	const handleMessageEvent = (event) => {
			const text = event.data;
			const textsofar = $("#answer").val();
			const newtext = textsofar + text;
			$("#answer").val(newtext);
			};
	
	const handleCloseEvent = (event) => {		
			closeConnection();
		};
			
	function establishConnection()
	{
		eventSource = new EventSource("http://localhost:8000/stream-answer");		
		eventSource.addEventListener("message", handleMessageEvent);
		eventSource.addEventListener("error", handleCloseEvent);
		connectionInProgress = true;
	}
	
	function closeConnection()
	{
		if (connectionInProgress == true)
		{			
			eventSource.close();		
			connectionInProgress = false;
		}		
	}
		
	function sendQuestionAsync() {		
	    closeConnection();	//make sure any streaming event connection currently running is closed
		var question = $("#question").val();
        var data = { "text": question };
		$("#submit-btn").prop("disabled", true); // Disable the submit buttons
		$("#submit-btn-async").prop("disabled", true);
        $("#embed-btn").prop("disabled", true);
		$(".spinner").show(); // Show the loading spinner
		$("#answer").val(""); // clear answer text area
		$("#rawresponse").val(""); //clear raw response text area
        $.ajax({
          type: "POST",
          url: "http://localhost:8000/query-async",
          data: JSON.stringify(data),
          contentType: "application/json; charset=utf-8",
          dataType: "json",
          success: function(response) {
            establishConnection();
														
			$("#submit-btn").prop("disabled", false); // Enable the submit buttons
			$("#submit-btn-async").prop("disabled", false);
            $("#embed-btn").prop("disabled", false);
			$(".spinner").hide(); // Hide the loading spinner
          },
          error: function(xhr, status, error) {
            alert("Error: " + error);
			$("#submit-btn").prop("disabled", false); // Enable the submit buttons
			$("#submit-btn-async").prop("disabled", false);
            $("#embed-btn").prop("disabled", false);
			$(".spinner").hide(); // Hide the loading spinner
          }
        });
	}

    function sendEmbedRequest() {
        closeConnection();	//make sure any streaming event connection currently running is closed
        var question = $("#question").val();
        var data = { "text": question };
        $("#submit-btn").prop("disabled", true); // Disable the submit buttons
        $("#submit-btn-async").prop("disabled", true);
        $("#embed-btn").prop("disabled", true);
        $(".spinner").show(); // Show the loading spinner
        $("#answer").val(""); // clear answer text area
        $("#rawresponse").val(""); //clear raw response text area
        $.ajax({
            type: "POST",
            url: "http://localhost:8000/get-embedding",
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {                
                $("#rawresponse").val(JSON.stringify(response));
                $("#submit-btn").prop("disabled", false); // Enable the submit buttons
                $("#submit-btn-async").prop("disabled", false);
                $("#embed-btn").prop("disabled", false);
                $(".spinner").hide(); // Hide the loading spinner
            },
            error: function (xhr, status, error) {
                alert("Error: " + error);
                $("#submit-btn").prop("disabled", false); // Enable the submit buttons
                $("#submit-btn-async").prop("disabled", false);
                $("#embed-btn").prop("disabled", false);
                $(".spinner").hide(); // Hide the loading spinner
            }
        });
    }
	  	  			  	 	 
    $("#question").on("input", function ()
    {
        var question = $(this).val();
        if (question.trim().length > 0)
        {
            $("#submit-btn").prop("disabled", false);
            $("#submit-btn-async").prop("disabled", false);
            $("#embed-btn").prop("disabled", false);
        } else
        {
            $("#submit-btn").prop("disabled", true);
            $("#submit-btn-async").prop("disabled", true);
            $("#embed-btn").prop("disabled", true);
        }
    });

    </script>
  </body>
</html>
